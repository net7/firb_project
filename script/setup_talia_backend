#!/Developer/Talia/jruby-1.3.1_2.3/bin/jruby

require File.dirname(__FILE__) + '/../config/boot'
require "#{RAILS_ROOT}/config/environment"
require 'rails_generator'
require 'rails_generator/scripts/generate'

puts "Install and configure restful authentication"
# First time plugin, has to be done this way since it can not be loaded in
# a different way
ARGV = ['install', 'git://github.com/technoweenie/restful-authentication.git']
require 'commands/plugin'
orig_name = $0
$0 = 'generate'
Rails::Generator::Scripts::Generate.new.run(%w(authenticated user sessions))

puts "Install and configure role-requirements"
Commands::Plugin.parse!(['install', 'git://github.com/timcharper/role_requirement.git'])
Rails::Generator::Scripts::Generate.new.run(%w(roles Role User))

if(Rails::VERSION::MAJOR > 2 ||(Rails::VERSION::MAJOR == 2 && Rails::VERSION::MINOR > 2))
  # TODO: Needed only as long as ActiveScaffold depends on it
  puts "Install the render_component plugin for ActiveScaffold (optional since Rails 2.2)"
  Commands::Plugin.parse!(['install', 'git://github.com/rails/render_component.git'])
end


puts "Install the adminstration backend"
Rails::Generator::Scripts::Generate.new.run(%w(talia_admin))

puts "Migrating the database"
system("rake db:migrate")

migration_path = File.join(RAILS_ROOT, 'db', 'migrate')
ActiveRecord::Migrator.migrate(migration_path)