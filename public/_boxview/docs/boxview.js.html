


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width; initial-scale=1.0">

  <title>
    API: BoxView
    
    
      &rarr; boxview.js (file)
    
  </title>

  <link rel="stylesheet" type="text/css" href="css/960fluid.min.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.4.custom.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="css/navigation.css">
  <link rel="stylesheet" type="text/css" href="css/content.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono">
  
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

</head>

<body>
  <div id="container" class="container_16">
    <a name="top"></a>

    <!-- HEADER -->
    <header>
      <div id="hd" class="grid_10">
        <h1>
          <a href="http://developer.yahoo.com/yui/" title="BoxView 1.0.3">BoxView 1.0.3</a> v
        </h1>
      </div> <!--! end of #hd -->
    </header>

    <div id="filters" class="grid_6">
      <form action="#" method="get" id="show-toggles">
        <fieldset>
          <legend>Display Filters</legend>
          <span class="classopts">
            <input type="checkbox" name="show_private" id="show_private">
            <label for="show_private">Show private</label>
          </span>
          <span class="classopts">
            <input type="checkbox" name="show_protected" id="show_protected">
            <label for="show_protected">Show protected</label>
          </span>
          <span class="classopts">
            <input type="checkbox" name="show_deprecated" id="show_deprecated">
            <label for="show_deprecated">Show deprecated</label>
          </span>
        </fieldset>
      </form>

    </div> <!--! end of #hd -->


    <!-- SUB-HEADER w/ BREADCRUMBS -->

    <div id="sub-hd" class="grid_16">
      <div id="breadcrumbs">
        <form id="search-form" method="get" action="#">
          <label for="search">Search:</label>
          <input type="text" id="search" title="Find documentation">
        </form>

        <a href="./index.html" title="BoxView 1.0.3">BoxView 1.0.3</a>
          &rarr; module <a href="./module_boxview.html" title="BoxView">BoxView</a>
          
          
            &rarr; file boxview.js
          
      </div>
    </div> <!--! end of #sub-hd -->
    
    <div class="clear"></div>
    

    <!-- SIDEBAR NAVIGATION -->
    <nav>
      <div id="navigation" class="grid_4">
        <div>

            <div id="moduleList" class="module">
              <h4>Modules</h4>
              <ul>
                  <li  class="selected" >
                    <a href="module_boxview.html">BoxView</a>
                  </li>
              </ul>
            </div>

            <div id="classList" class="module">
              <h4>Classes</h4>
              <ul>
                  <li >
                    <a href="BoxViewSuiteConfig.html">BoxViewSuiteConfig</a>
                  </li>
              </ul>
            </div>

            <div id="fileList" class="module">
              <h4>Files</h4>
              <ul>
                  <li >
                    <a href="anchorman.js.html">anchorman.js</a>
                  </li>
                  <li >
                    <a href="boxtoolbar.js.html">boxtoolbar.js</a>
                  </li>
                  <li  class="selected" >
                    <a href="boxview.js.html">boxview.js</a>
                  </li>
                  <li >
                    <a href="boxview_config.js.html">boxview_config.js</a>
                  </li>
                  <li >
                    <a href="tools.js.html">tools.js</a>
                  </li>
                  <li >
                    <a href="urlshortener.js.html">urlshortener.js</a>
                  </li>
                  <li >
                    <a href="widgets.js.html">widgets.js</a>
                  </li>
              </ul>
            </div>





        </div>
      </div>  <!-- end of #navigation -->
    </nav>


    <div id="content" class="grid_12">
      


        <!--! source code view -->
        <div id="srcout">
          <h2>
            file <strong>boxview.js</strong>
          </h2>

          <div class="highlight"><pre><span class="cm">/* Copyright (c) 2012 Net7 SRL, &lt;http://www.netseven.it/&gt;       */</span>
<span class="cm">/* This Software is released under the terms of the MIT License */</span>
<span class="cm">/* See LICENSE.TXT for the full text of the license.            */</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>  
	
	<span class="c1">// BoxView jQuery object constructor</span>
	<span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">boxView</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// get &quot;real&quot; options merging defaults and </span>
		<span class="c1">// opts given by user</span>
		<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

		<span class="c1">// Spawn a boxview for every element we are calling this on</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
			<span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
		<span class="p">});</span>

	<span class="p">};</span> <span class="c1">// $.fn.boxView()</span>


 	<span class="c1">// BoxView constructor</span>
	<span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
		
		<span class="c1">// Global options for this boxView, right into the object</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

		<span class="c1">// Boxes container</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

	<span class="p">};</span> <span class="c1">// $.boxView()</span>


	<span class="c1">// DEFAULTS: Every boxView will be initialized with these defaults</span>
	<span class="c1">// if not explicitly overwritten by the user</span>
	<span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
		<span class="c1">// Class added to the box when collapsed</span>
		<span class="nx">collapsedClass</span><span class="o">:</span> <span class="s1">&#39;collapsedBox&#39;</span><span class="p">,</span>

		<span class="c1">// Class added to the box when expanded</span>
		<span class="nx">expandedClass</span><span class="o">:</span> <span class="s1">&#39;expandedBox&#39;</span><span class="p">,</span>
		
		<span class="c1">// Class added while the box is loading</span>
		<span class="nx">loadingClass</span><span class="o">:</span> <span class="s1">&#39;loadingContent&#39;</span><span class="p">,</span>
		
		<span class="c1">// Default type (used as class in the markup)</span>
		<span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;defType&#39;</span><span class="p">,</span>

		<span class="c1">// Is a box collapsable?</span>
		<span class="nx">collapsable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

		<span class="c1">// Is a box draggable?</span>
		<span class="nx">draggable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> 

		<span class="c1">// Is a box closable?</span>
		<span class="nx">closable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

		<span class="c1">// Is a box initially collapsed?</span>
		<span class="nx">collapsed</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

		<span class="c1">// Box width when collapsed, pixels</span>
		<span class="nx">collapsedWidth</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>

        <span class="c1">// Box header height when collapsed, usually contains tools like close/expand</span>
        <span class="nx">collapsedHeaderHeight</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>

        <span class="c1">// Box header height when expanded, contains tools and title</span>
        <span class="nx">headerHeight</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
        
        <span class="c1">// TODO</span>
        <span class="nx">headerTitleMargin</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>

        <span class="c1">// TODO</span>
        <span class="nx">iconSize</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
        
        <span class="c1">// TODO </span>
        <span class="nx">iconSlotsHorizontalMargin</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
        
        <span class="c1">// TODO</span>
        <span class="nx">iconsVerticalTopMargin</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>

        <span class="nx">iconsAlignment</span><span class="o">:</span> <span class="s1">&#39;alignMiddle&#39;</span><span class="p">,</span>

        <span class="c1">// Enforce max/min width for this box?</span>
        <span class="nx">maxWidth</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">minWidth</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

		<span class="c1">// Space between boxes</span>
		<span class="nx">boxMargin</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		
		<span class="c1">// Pixel to substrat to box width when setting .resizeme images</span>
		<span class="nx">resizemeImagesMargin</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span>

        <span class="c1">// Maximum width (in pixels) for the .resizeme elements</span>
        <span class="nx">resizemeImagesForceMaxHeight</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">resizemeImagesMaxHeight</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
        <span class="nx">resizemeImagesMinHeight</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        
		<span class="c1">// Animations</span>
		<span class="nx">animateAdd</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">animateRemove</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">animateCollapse</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">animateResize</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

        <span class="c1">// Shortcut to set all of the animations, overrides any other </span>
        <span class="c1">// given animate* parameter</span>
		<span class="nx">animations</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

		<span class="nx">animationLength</span><span class="o">:</span> <span class="mi">450</span><span class="p">,</span>

        <span class="c1">// Default fields to be used for anchorman description</span>
        <span class="nx">anchorManDescription</span><span class="o">:</span> <span class="p">[</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;resId&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsed&#39;</span><span class="p">,</span> <span class="s1">&#39;qstring&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;verticalTitle&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;closable&#39;</span><span class="p">,</span> <span class="s1">&#39;collapsable&#39;</span><span class="p">,</span> <span class="s1">&#39;draggable&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;minWidth&#39;</span><span class="p">,</span> <span class="s1">&#39;maxWidth&#39;</span>
        <span class="p">],</span>

		<span class="c1">// Will check every animationLength+lazyResizeInterval ms if boxview&#39;s container width/height are</span>
		<span class="c1">// changed</span>
		<span class="nx">lazyResizeInterval</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>

		<span class="c1">// Default title and resource id</span>
		<span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Default box title&quot;</span><span class="p">,</span>
		<span class="nx">verticalTitle</span><span class="o">:</span> <span class="s2">&quot;Default vertical title&quot;</span><span class="p">,</span>
		<span class="nx">resId</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        
        <span class="c1">//////////////// Used internally ////////////////</span>
		<span class="nx">isBeingDragged</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">isFirstShow</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="nx">isLoading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		
		<span class="nx">debug</span><span class="o">:</span> <span class="kc">false</span>
	<span class="p">};</span>

	
	<span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">init</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

            <span class="c1">// Used in almost every listener</span>
			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="c1">// Will contain the reference to the boxstrapper object, for the loading utils</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">boxStrapper</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            
			<span class="c1">// Create a name for this boxView</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createHash</span><span class="p">();</span>

			<span class="c1">// Add the real boxview container (bvc) and get the jQuery object, </span>
			<span class="c1">// get the son of this container so we can add as many boxViews</span>
			<span class="c1">// as needed on the same page</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div id=&#39;&quot;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot;&#39; class=&#39;boxViewContainer&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bvc</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxViewName</span><span class="p">);</span>

			<span class="c1">// Current number of boxes</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			
			<span class="c1">// Options objects for each box</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span> <span class="o">=</span> <span class="p">[];</span>
			
            <span class="c1">// Will contain informations about open and closed boxes</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="p">[];</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">useWidgets</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">widgets</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">globalHelperName</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">useWidgets</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">widgets</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">$</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">globalHelperName</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">bindBVListener</span><span class="p">();</span>
			<span class="p">}</span>
			
			<span class="c1">// Is the boxview double check running?</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">waitingDoubleCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			
			<span class="c1">// Connect some callbacks, if there&#39;s any in the options object. Add a function called</span>
			<span class="c1">// *AddCallBack (for example .onSortAddCallBack() or .onAddAddCallBack()) to the boxview</span>
			<span class="c1">// object, to let the user add his own callbacks</span>
            <span class="kd">var</span> <span class="nx">callBacks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;onSort&quot;</span><span class="p">,</span> <span class="s2">&quot;onAdd&quot;</span><span class="p">,</span> <span class="s2">&quot;onRemove&quot;</span><span class="p">,</span> <span class="s2">&quot;onCollapse&quot;</span><span class="p">,</span> <span class="s2">&quot;onExpand&quot;</span><span class="p">,</span> <span class="s2">&quot;onReplace&quot;</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">callBacks</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">callBacks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

                <span class="c1">// Sets an empty array or the function supplied in the option object</span>
                <span class="nx">self</span><span class="p">[</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;Functions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]]</span> <span class="o">:</span> <span class="p">[];</span>

                <span class="c1">// Sets the *AddCallback function</span>
                <span class="nx">self</span><span class="p">[</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;AddCallBack&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Adding a callback function to &quot;</span><span class="o">+</span><span class="nx">n</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span> <span class="nx">f</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">self</span><span class="p">[</span><span class="nx">n</span> <span class="o">+</span> <span class="s2">&quot;Functions&quot;</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
                    <span class="p">}})(</span><span class="nx">name</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="c1">// Shortcut to set all of the animations, overrides any other </span>
            <span class="c1">// given animate* parameter</span>
            <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span> 
    		<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">animations</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> 
        		<span class="nx">o</span><span class="p">.</span><span class="nx">animateAdd</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">animateRemove</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">animateCollapse</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">animateResize</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">animations</span><span class="p">;</span>

            <span class="c1">// true if we are dragging a box</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="c1">// Will be used to notice if box order has changed during dragNdrop, </span>
			<span class="c1">// if it&#39;s changed the orderChangeFunction will be called passing this</span>
			<span class="c1">// order as parameter</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">lazyResizeTimer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
                <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">width</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Lazy resizing spotted a wrong sized boxview!&quot;</span><span class="p">);</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
                <span class="p">}</span>
			<span class="p">},</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lazyResizeInterval</span><span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">);</span>

			<span class="c1">// Adding the event delegation for collapse and remove tool, bind it</span>
			<span class="c1">// to this div only so if there are more boxviews on the same page we</span>
			<span class="c1">// dont bind twice every element</span>
			<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;div#&quot;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.boxHeader div .removeTool&quot;</span><span class="p">).</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
					<span class="nx">self</span><span class="p">.</span><span class="nx">removeBox</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;div.box&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
					<span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
					<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">});</span>
			<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;div#&quot;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.boxHeader div .collapseTool&quot;</span><span class="p">).</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
					<span class="nx">self</span><span class="p">.</span><span class="nx">toggleCollapseBox</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;div.box&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
					<span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
					<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">});</span>
			<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;div#&quot;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.box.collapsable div.boxHeader, div#&quot;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.box.collapsable div.boxCollapsedContent&quot;</span><span class="p">).</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;dblclick&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
				    <span class="nx">self</span><span class="p">.</span><span class="nx">toggleCollapseBox</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;div.box&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
					<span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
					<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">});</span>

            <span class="c1">// Event delegation for history box items</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;div#&quot;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.widget div.history_item span.history_action&quot;</span><span class="p">).</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">historyHandleClick</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;div#&quot;</span><span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxViewName</span> <span class="o">+</span><span class="s2">&quot; div.widget div.history_item&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;mouseenter&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">historyHandleMouseEnter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">live</span><span class="p">(</span><span class="s2">&quot;mouseleave&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">historyHandleMouseLeave</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="p">});</span>

			<span class="c1">// Little IE fix: put a timer to buffer mutiple resize events:</span>
			<span class="c1">// this will call resize() only after N ms after user stopped </span>
			<span class="c1">// resizing the window</span>
			<span class="kd">var</span> <span class="nx">resizeTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
			    <span class="k">if</span> <span class="p">(</span><span class="nx">resizeTimer</span><span class="p">)</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">resizeTimer</span><span class="p">);</span>
			    <span class="nx">resizeTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span> <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
			<span class="p">});</span>

			<span class="c1">// Initial positioning</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>

		<span class="p">},</span> <span class="c1">// init()</span>
		
		<span class="c1">// Recalculate sizes of all boxes</span>
		<span class="nx">resize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

			<span class="c1">// Make the box container height match its own container&#39;s height</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">width</span><span class="p">());</span>

			<span class="c1">// No boxes -&gt; no resize</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="c1">// Set all boxes height to match bvc&#39;s height, both the exterior div.box</span>
			<span class="c1">// and the internal div.boxContent heights!</span>
			<span class="kd">var</span> <span class="nx">fooH</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">headerHeight</span><span class="p">;</span>
			<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.box&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
			<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.box div.boxContent&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">fooH</span><span class="p">);</span>

			<span class="c1">// num of expanded/collapsed boxes and</span>
			<span class="c1">// width available to the expanded boxes</span>
			<span class="kd">var</span> <span class="nx">expanded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nx">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				<span class="nx">startingExpandedWidth</span> <span class="o">=</span> <span class="nx">expandedWidth</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">).</span><span class="nx">width</span><span class="p">(),</span>
				<span class="nx">fixBoxes</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="c1">// If we have a collapsed box substract this collapsed box</span>
			<span class="c1">// width from the width available to expanded boxes</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>
				    <span class="kd">var</span> <span class="nx">cw</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsedWidth</span><span class="p">);</span>
					<span class="nx">expandedWidth</span> <span class="o">-=</span> <span class="nx">cw</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">cw</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">minWidth</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">maxWidth</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fixBoxes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
                    <span class="nx">fixed</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> 
					<span class="nx">expanded</span><span class="o">++</span><span class="p">;</span>

			<span class="c1">// subtract margins from boxes available width</span>
			<span class="nx">expandedWidth</span> <span class="o">-=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">boxMargin</span> <span class="o">*</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="c1">// BaseWidth is exactly the expanded boxes available width divided</span>
			<span class="c1">// by the num of exp. boxes, WidthRemainder is the division remainder.</span>
			<span class="kd">var</span> <span class="nx">boxBaseWidth</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">expandedWidth</span> <span class="o">/</span> <span class="p">(</span><span class="nx">expanded</span><span class="o">+</span><span class="nx">fixed</span><span class="p">)),</span>
			    <span class="nx">boxWidthRemainder</span><span class="p">;</span>

            <span class="c1">// Max and/or min width: check if we must enforce a fixed width and</span>
            <span class="c1">// do so if needed. Fixed width boxes will decrease expandedWidth for</span>
            <span class="c1">// the other boxes, which will be sized later accordingly</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">fixed</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">fixBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">]],</span>
                    <span class="nx">min</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">minWidth</span><span class="p">)</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">minWidth</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">max</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">)</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
                    
                <span class="nx">b</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">min</span> <span class="o">&amp;&amp;</span> <span class="nx">min</span> <span class="o">&gt;</span> <span class="nx">boxBaseWidth</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">b</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">min</span><span class="p">;</span>
                    <span class="nx">b</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">max</span> <span class="o">&amp;&amp;</span> <span class="nx">max</span> <span class="o">&lt;</span> <span class="nx">boxBaseWidth</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">b</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
                    <span class="nx">b</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">fixed</span><span class="p">)</span>
                    <span class="nx">expandedWidth</span> <span class="o">-=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">expanded</span><span class="o">++</span><span class="p">;</span>
                    <span class="nx">fixed</span><span class="o">--</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
			
			<span class="c1">// Calculate again the base width for expanded non-fixed boxes</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">fixed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="nx">boxBaseWidth</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">expandedWidth</span> <span class="o">/</span> <span class="nx">expanded</span><span class="p">);</span>
			<span class="nx">boxWidthRemainder</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">expandedWidth</span> <span class="o">%</span> <span class="nx">expanded</span><span class="p">);</span>

			<span class="c1">// foox will keep the &#39;left&#39; css value of the current box, to</span>
			<span class="c1">// position boxes from left to right.</span>
			<span class="c1">// The cycle will add an extra width pixel for each box until</span>
			<span class="c1">// boxWidthRemainder is consumed</span>
			<span class="kd">var</span> <span class="nx">foox</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

				<span class="c1">// calculate this box width and left position</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">fixed</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// We already calculated this box width</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="c1">// if boxWidthRemainder is greater than 0, we enlarge</span>
					<span class="c1">// this box width by 1 pixel, decreasing boxWidhtRemainder by 1</span>
					<span class="kd">var</span> <span class="nx">correction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">boxWidthRemainder</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">boxBaseWidth</span> <span class="o">+</span> <span class="nx">correction</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">foox</span><span class="p">;</span>
				<span class="nx">foox</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">boxMargin</span><span class="p">;</span>

			<span class="p">}</span> <span class="c1">// for i</span>

			<span class="c1">// Finally repaint with the new values</span>
			<span class="nx">self</span><span class="p">.</span><span class="nx">repaint</span><span class="p">();</span>

            <span class="c1">// Double check after repaint:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">waitingDoubleCheck</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">self</span><span class="p">.</span><span class="nx">waitingDoubleCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
					<span class="nx">self</span><span class="p">.</span><span class="nx">waitingDoubleCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			        <span class="k">if</span> <span class="p">(</span><span class="nx">startingExpandedWidth</span> <span class="o">!=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">bvc</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxesDimensionsCheck</span><span class="p">())</span> <span class="p">{</span>
			            <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Double check failed!&quot;</span><span class="p">);</span>
			            <span class="nx">self</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
			        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			            <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Double check BVC width passed.&quot;</span><span class="p">);</span>
			        <span class="p">}</span>
			    <span class="p">},</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="o">+</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
                
		<span class="p">},</span> <span class="c1">// resize()</span>

		<span class="c1">// Will return true if there is a box with width or left css</span>
		<span class="c1">// values not in sync with internal computed ones</span>
		<span class="nx">boxesDimensionsCheck</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
					<span class="nx">left</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span>
					<span class="nx">width</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">left</span> <span class="o">||</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> 
					<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="c1">// for i</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
		<span class="p">},</span> <span class="c1">// boxesDimensionsCheck</span>

		<span class="c1">// Draws/animates the new positions and sizes of all boxes</span>
		<span class="nx">repaint</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">box</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>

                <span class="c1">// Dont redraw everything if we are dragging .. </span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>

				    <span class="kd">var</span> <span class="nx">hid</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxHeader&#39;</span><span class="p">,</span>
				        <span class="nx">toolsSize</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; ul li&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSize</span><span class="p">;</span>

    				<span class="c1">// Resize the collapsed and expanded content to parent&#39;s width and height</span>
    				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>
    				     
    				    <span class="c1">// collapsed header height: toolsSize + a singol margin (at bottom)</span>
    				    <span class="kd">var</span> <span class="nx">headerHeight</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collapsedHeaderHeight</span><span class="p">,</span> <span class="nx">toolsSize</span><span class="p">),</span> <span class="c1">//+this.options.iconsVerticalTopMargin),</span>
    				        <span class="nx">h</span> <span class="o">=</span> <span class="nx">box</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="nx">headerHeight</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconsVerticalTopMargin</span><span class="p">,</span>
                            <span class="nx">e</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxCollapsedContent&#39;</span><span class="p">);</span>
    				    
    				    <span class="c1">// Check if the height is different (is it a vertical resize?)</span>
    				    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    					    <span class="nx">e</span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
    					    <span class="nx">e</span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">);</span>

    					    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxCollapsedContent .verticalContainer&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">h</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                        <span class="p">}</span>

                        <span class="c1">// Do this at least at every add+collapse+expand</span>
                        <span class="c1">// Tools: when collapsed they get their minimal height</span>
                        <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li, &quot;</span><span class="o">+</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li a&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSize</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsedWidth</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">headerHeight</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxCollapsedContent .verticalContainer&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsedWidth</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="nx">bottom</span><span class="o">:</span> <span class="o">-</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collapsedWidth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
    				    
    				    <span class="c1">// Used to push down icon slots inside boxHeader</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;padding-top&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconsVerticalTopMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>

    				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        
    				    <span class="c1">// Heights for expanded header, tools and A tags</span>
    				    <span class="c1">// TODO: make this height follow the content of the title if its too long? </span>
    				    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li, &quot;</span><span class="o">+</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li a&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">headerHeight</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li a, &quot;</span><span class="o">+</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSize</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>

                        <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .leftIcons&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSlotsHorizontalMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                        <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .rightIcons&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="nx">right</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSlotsHorizontalMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>

                        <span class="c1">// Reset margins used to push down icon slots when collapsed</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;padding-top&#39;</span><span class="o">:</span> <span class="s1">&#39;0px&#39;</span><span class="p">});</span>

                        <span class="c1">// Size content</span>
    				    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxContent&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerHeight</span><span class="p">);</span>
    				    
				    <span class="p">}</span>

                    <span class="c1">// DEBUG: one time only?</span>
                    <span class="c1">// Set vertical title along with its first dimensions</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxCollapsedContent .verticalContainer&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">verticalTitle</span><span class="o">+</span><span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">innerP</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; div.boxCollapsedContent .verticalContainer p&#39;</span><span class="p">),</span>
                        <span class="nx">ph</span> <span class="o">=</span> <span class="nx">innerP</span><span class="p">.</span><span class="nx">height</span><span class="p">(),</span>
                        <span class="nx">collMargin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsedWidth</span> <span class="o">-</span> <span class="nx">ph</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

                    <span class="c1">// TODO: do this once</span>
                    <span class="c1">// Icons aligments</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; li a&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconsAlignment</span><span class="p">);</span>

                    <span class="c1">// Right and left should be set to give it some vertical margin</span>
                   	<span class="nx">innerP</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="s2">&quot;margin-right&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerTitleMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span>
                   	            <span class="s1">&#39;margin-left&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerTitleMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	
                   	<span class="c1">// TODO alignment ?</span>
                   	<span class="k">if</span> <span class="p">(</span><span class="nx">ph</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsedWidth</span><span class="p">)</span>
                   	    <span class="nx">innerP</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="s2">&quot;margin-top&quot;</span><span class="o">:</span> <span class="nx">collMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	<span class="k">else</span>
                   	    <span class="nx">innerP</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="s2">&quot;margin-top&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerTitleMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	
                   	<span class="c1">// Box Header title when expanded</span>
                   	<span class="kd">var</span> <span class="nx">titleLeft</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .leftIcons li&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSize</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">headerTitleMargin</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSlotsHorizontalMargin</span><span class="p">,</span>
                   	    <span class="nx">titleRight</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .rightIcons li&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSize</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">headerTitleMargin</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">iconSlotsHorizontalMargin</span><span class="p">;</span>
                   	<span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .title&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;margin-left&#39;</span><span class="o">:</span> <span class="nx">titleLeft</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="s1">&#39;margin-right&#39;</span><span class="o">:</span> <span class="nx">titleRight</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	
                   	<span class="kd">var</span> <span class="nx">titleHeight</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .title h3&quot;</span><span class="p">).</span><span class="nx">height</span><span class="p">(),</span>
                   	    <span class="nx">expMargin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerHeight</span> <span class="o">-</span> <span class="nx">titleHeight</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

                    <span class="c1">// TODO: align title</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">titleHeight</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">headerHeight</span><span class="p">)</span>
                   	    <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .title h3&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;margin-top&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">headerTitleMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	<span class="k">else</span>
               	        <span class="nx">$</span><span class="p">(</span><span class="nx">hid</span><span class="o">+</span><span class="s2">&quot; .title h3&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;margin-top&#39;</span><span class="o">:</span> <span class="nx">expMargin</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                   	    
				
                    <span class="c1">// width of this box minus a resizeme margin</span>
            		<span class="kd">var</span> <span class="nx">resizemeWidth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resizemeImagesMargin</span><span class="p">;</span>

            		<span class="c1">// Autoresize &quot;resizeme&quot; class: img just set the width, divs are flash containers</span>
            		<span class="c1">// need to get the ratio and act concordingly</span>
            		<span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; img.resizeme&quot;</span><span class="p">),</span>
                        <span class="nx">obj</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; div.resizeme&quot;</span><span class="p">),</span>
                        <span class="nx">ratio</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;object.IMTViewer:first&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;ratio&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">10000</span><span class="p">,</span>
                        <span class="nx">objHeight</span> <span class="o">=</span> <span class="nx">resizemeWidth</span><span class="o">*</span><span class="nx">ratio</span><span class="o">/</span><span class="mi">10000</span><span class="p">;</span>

        			<span class="k">if</span> <span class="p">(</span><span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">resizemeWidth</span><span class="p">)</span>
        			    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateResize</span><span class="p">)</span> <span class="p">{</span>
        				    <span class="nx">img</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="nx">resizemeWidth</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">);</span>
                            <span class="nx">obj</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="nx">resizemeWidth</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">objHeight</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">);</span>
        				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">img</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="nx">resizemeWidth</span><span class="p">});</span>
                            <span class="nx">obj</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="nx">resizemeWidth</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">objHeight</span><span class="p">});</span>
    				    <span class="p">}</span>
        		
        		    <span class="c1">// .resizing is used for images where the resizable() object is ready.</span>
        		    <span class="c1">// Set new Max dimensions to match box width.</span>
        			<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.resizing&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">resizeResizable</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">resizemeWidth</span><span class="p">);</span> <span class="p">});</span>
    				
    				<span class="c1">// .firstresize is a freshly added image. The resizable() object needs to</span>
    				<span class="c1">// be initialized when the image is loaded, so we can get real </span>
    				<span class="c1">// image width and height and save the ratio for later use</span>
    				<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.firstresize&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        				<span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;firstresize&#39;</span><span class="p">);</span>
        				<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">e</span><span class="p">.</span><span class="nx">onload</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> 
                			<span class="nx">e</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">resizable</span><span class="p">({</span><span class="nx">aspectRatio</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
                                <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;resizing&#39;</span><span class="p">);</span>
                			    <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;originalRatio&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">e</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>

                                <span class="nx">self</span><span class="p">.</span><span class="nx">resizeResizable</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">resizemeWidth</span><span class="p">);</span>
                			<span class="p">};</span>
            		<span class="p">});</span>

                <span class="p">}</span> <span class="c1">// if !this.dragging</span>

				<span class="c1">// First time we display this box, animate or not?</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isFirstShow</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateAdd</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">box</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="s1">&#39;10px&#39;</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">)});</span>
						<span class="nx">box</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">useWidgets</span><span class="p">)</span>
						    	<span class="k">this</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">resizeWidgets</span><span class="p">();</span>
						<span class="p">});</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					    <span class="c1">// Added a micro animation of 10msecs to avoid IE&#39;s flaws when rendering</span>
					    <span class="c1">// Ajax-added content........ thanks IE!</span>
						<span class="nx">box</span><span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span><span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
					<span class="p">}</span>
						
					<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isFirstShow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="c1">// Dont redraw the items which are being dragged!</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isBeingDragged</span><span class="p">)</span> 
						<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateResize</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
							<span class="nx">box</span><span class="p">.</span><span class="nx">stop</span><span class="p">().</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
							    <span class="p">.</span><span class="nx">animate</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span><span class="p">},</span> 
							        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">,</span>
							        <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">useWidgets</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">resizeWidgets</span><span class="p">();</span> <span class="p">});</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="nx">box</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span><span class="p">});</span>
							<span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">useWidgets</span><span class="p">)</span>
								<span class="nx">self</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">resizeWidgets</span><span class="p">();</span>
						    
						<span class="p">}</span>

				<span class="p">}</span> <span class="c1">// if isFirtShow()</span>

			<span class="p">}</span> <span class="c1">// for i=0..this.n</span>

		<span class="p">},</span> <span class="c1">// repaint()</span>

        <span class="nx">resizeResizable</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">availableWidth</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;originalRatio&#39;</span><span class="p">),</span>
		        <span class="nx">minH</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesMinHeight</span><span class="p">,</span>
		        <span class="nx">minW</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">minH</span> <span class="o">/</span> <span class="nx">ratio</span><span class="p">),</span>
		        <span class="nx">currW</span> <span class="o">=</span> <span class="nx">maxW</span> <span class="o">=</span> <span class="nx">availableWidth</span><span class="p">,</span>
		        <span class="nx">currH</span> <span class="o">=</span> <span class="nx">maxH</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">ratio</span> <span class="o">*</span> <span class="nx">availableWidth</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesForceMaxHeight</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">currH</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">maxH</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesMaxHeight</span><span class="p">);</span>
                <span class="nx">currW</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">currH</span><span class="o">/</span><span class="nx">ratio</span><span class="p">);</span>
            <span class="p">}</span>
		    
		    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">currH</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">currW</span> <span class="o">&amp;&amp;</span> <span class="nx">currW</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">currH</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span> <span class="nx">currH</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">currW</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">resizable</span><span class="p">(</span><span class="s2">&quot;widget&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="nx">height</span><span class="o">:</span> <span class="nx">currH</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">currW</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">});</span>
		        <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">resizable</span><span class="p">(</span><span class="s2">&quot;option&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">minHeight</span><span class="o">:</span> <span class="nx">minH</span><span class="p">,</span> <span class="nx">maxHeight</span><span class="o">:</span> <span class="nx">maxH</span><span class="p">,</span> <span class="nx">minWidth</span><span class="o">:</span> <span class="nx">minW</span><span class="p">,</span> <span class="nx">maxWidth</span><span class="o">:</span> <span class="nx">maxW</span><span class="p">});</span>
		    <span class="p">}</span>
        <span class="p">},</span> <span class="c1">// resizeResizable()</span>
		
		<span class="c1">// Will add a box and call the callbacks</span>
		<span class="nx">addBox</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">boxContent</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="k">in</span> <span class="nx">opts</span><span class="p">)</span>  
				<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> 
					<span class="nx">opts</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> 

			<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Calling addBox with &quot;</span><span class="o">+</span><span class="nx">opts</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span>
			 	<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resId</span><span class="p">)</span> 
                    <span class="c1">// Flash the box if this resId is already open!</span>
			 		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getIdFromResId</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;There&#39;s already a box with resId=&quot;</span><span class="o">+</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;resId&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; .. flashing it&quot;</span><span class="p">);</span>
						<span class="c1">// TODO: add an option to animate the flash window or flash it always ..</span>
						<span class="c1">// if (this.options.animateResize === true)</span>
						<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">getIdFromResId</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span><span class="p">)).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;0.3&quot;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;0.3&quot;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">);</span>
							
						<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
					<span class="p">}</span>

			<span class="c1">// If there&#39;s a position supplied, copy the actual boxOptions hash</span>
			<span class="c1">// leaving a blank space in the Nth position, then do the</span>
			<span class="c1">// usual stuff on boxOptions[n]</span>
			<span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="kc">NaN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
				<span class="nx">n</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>

			<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="nx">foo</span><span class="p">[</span><span class="s1">&#39;boxOptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

				<span class="c1">// Cycle over all boxes and just skip the nth box</span>
				<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
					<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> 
						<span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">],</span> <span class="p">{});</span>
						
				<span class="c1">// Copy back the options in boxOptions</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">,</span> <span class="p">{});</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="c1">// Otherwise just add it in the last position</span>
				<span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Adding a box in position &quot;</span><span class="o">+</span><span class="nx">n</span><span class="p">);</span>

			<span class="c1">// Extend default options with those given by user</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">boxopt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>

			<span class="c1">// If there&#39;s already an id, use it</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
				<span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

            <span class="c1">// If we are using the default, use the id as resId value</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">boxopt</span><span class="p">.</span><span class="nx">resId</span> <span class="o">===</span> <span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">resId</span><span class="p">)</span>
                <span class="nx">boxopt</span><span class="p">.</span><span class="nx">resId</span> <span class="o">=</span> <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>

            <span class="c1">// Fix unusual values for collapsed flag</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
                <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            
            <span class="c1">// Content of the box and its full HTML markup</span>
			<span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">boxContent</span><span class="p">;</span>
			<span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getBoxHtml</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>

			<span class="c1">// Adding the box to the boxviewcontainer</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="c1">// Make boxes draggable, sets some properties and attach functions</span>
			<span class="c1">// to handle drag, dragstart and dragend inside boxView.</span>
			<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;draggable&#39;</span><span class="p">])</span>
				<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]).</span><span class="nx">draggable</span><span class="p">({</span> 
					<span class="nx">containment</span><span class="o">:</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> 
					<span class="nx">handle</span><span class="o">:</span> <span class="s1">&#39;.boxDragHandle&#39;</span><span class="p">,</span>
					<span class="nx">cursor</span><span class="o">:</span> <span class="s1">&#39;move&#39;</span><span class="p">,</span>
					<span class="nx">zIndex</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
					<span class="nx">stack</span><span class="o">:</span> <span class="s1">&#39;div.box&#39;</span><span class="p">,</span>
					<span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.70</span><span class="p">,</span>
					<span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dragStart</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span> <span class="p">},</span>
					<span class="nx">drag</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">drag</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span> <span class="p">},</span>
					<span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dragStop</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span> <span class="p">}</span>
				<span class="p">});</span>

			<span class="cm">/*</span>
<span class="cm">			// DEBUG: this crashes IE ..... fun.</span>
<span class="cm">			$(&quot;#&quot;+boxopt[&#39;id&#39;]+&quot; .resizable:not[.resizing]&quot;).each(function(i, e) {</span>
<span class="cm">				self.log(&#39;estiqaatsi&#39;);</span>
<span class="cm">			    $(e).addClass(&#39;firstresize&#39;);</span>
<span class="cm">				return false;</span>
<span class="cm">			});</span>
<span class="cm">			*/</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Added box &quot;</span><span class="o">+</span><span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; in position &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">+</span> <span class="s2">&quot; with resId &quot;</span> <span class="o">+</span>  <span class="nx">boxopt</span><span class="p">[</span><span class="s1">&#39;resId&#39;</span><span class="p">]);</span>

			<span class="c1">// Calculate sizes again</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">historyAdd</span><span class="p">(</span><span class="nx">boxopt</span><span class="p">);</span>
			
			<span class="c1">// Call the onAdd callback</span>
			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onAddFunctions</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span>
			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
			            <span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">boxopt</span><span class="p">.</span><span class="nx">resId</span><span class="p">);</span>

		<span class="p">},</span> <span class="c1">// addBox()</span>


        <span class="c1">// TODO: initial addBoxFromAjax function, to make the user skip the ajax call and</span>
        <span class="c1">// control them better</span>
        <span class="nx">addBoxFromAjax</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Called addBoxFromAjax without qstring ... what should i load? :|&#39;</span><span class="p">);</span>
				<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
			<span class="p">}</span>

            <span class="c1">// DEBUG: put this into some fixed variable and not into a string</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">===</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">boxStrapper</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">boxStrapper</span><span class="p">.</span><span class="nx">addLoadingItem</span><span class="p">(</span><span class="s2">&quot;Box: &quot;</span><span class="o">+</span><span class="nx">opts</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>

		    <span class="c1">// DEBUG IE: random string to trick the cache, if there&#39;s no</span>
			<span class="c1">// question mark, add it.. else use &amp;</span>
			<span class="c1">// TODO DEBUG: is this enough? :|</span>
		    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\?/</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span>
					<span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">+=</span> <span class="s1">&#39;?ie=&#39;</span><span class="o">+</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;ie=&#39;</span><span class="o">+</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">);</span>

            <span class="c1">// TODO: make some sanity checks, is the box already open? Flash and return?</span>
            <span class="c1">// are the informations correct? Set loading?</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">,</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
	  				<span class="nx">self</span><span class="p">.</span><span class="nx">addBox</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>  
                    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">boxStrapper</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">boxStrapper</span><span class="p">.</span><span class="nx">removeLoadedItem</span><span class="p">(</span><span class="s2">&quot;Box: &quot;</span><span class="o">+</span><span class="nx">opts</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
            
        <span class="p">},</span> <span class="c1">// addBoxFromAjax</span>

        <span class="nx">getBoxHtml</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">n</span><span class="p">],</span>
            	<span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div class=&#39;box &quot;</span> <span class="o">+</span> <span class="nx">b</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">;</span>

            <span class="nx">html</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;collapsed&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;collapsed &#39;</span> <span class="o">:</span> <span class="s1">&#39;expanded &#39;</span><span class="p">;</span>
            <span class="nx">html</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;collapsable&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;collapsable &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nx">html</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;draggable&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;draggable &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nx">html</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;closable&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="s1">&#39;closable &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

            <span class="nx">html</span> <span class="o">+=</span> <span class="s2">&quot;&#39; id=&#39;&quot;</span><span class="o">+</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;&gt;&quot;</span><span class="o">+</span>
            		<span class="s2">&quot;&lt;div class=&#39;boxHeader boxDragHandle&#39;&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;div class=&#39;leftIcons&#39;&gt;&quot;</span><span class="o">+</span>
            				<span class="s2">&quot;&lt;ul&gt;&quot;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;collapsable&#39;</span><span class="p">])</span>
            	<span class="nx">html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;li class=&#39;collapseTool&#39;&gt;&lt;a class=&#39;collapseTool&#39; href=&#39;&#39;&gt;Collapse&lt;/a&gt;&lt;/li&gt;&quot;</span><span class="p">;</span>

			<span class="nx">html</span> <span class="o">+=</span> 		<span class="s2">&quot;&lt;/ul&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;div class=&#39;title&#39;&gt;&quot;</span><span class="o">+</span>
            				<span class="s2">&quot;&lt;h3 class=&#39;boxHeaderTitle&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">b</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/h3&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;div class=&#39;rightIcons&#39;&gt;&quot;</span><span class="o">+</span>
            				<span class="s2">&quot;&lt;ul&gt;&quot;</span><span class="p">;</span>
							
			<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;closable&#39;</span><span class="p">])</span>
    			<span class="nx">html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;li class=&#39;removeTool&#39;&gt;&lt;a class=&#39;removeTool&#39; href=&#39;&#39;&gt;Close&lt;/a&gt;&lt;/li&gt;&quot;</span><span class="p">;</span>

			<span class="nx">html</span> <span class="o">+=</span>			<span class="s2">&quot;&lt;/ul&gt;&quot;</span><span class="o">+</span>
            			<span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="o">+</span>
            		<span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="o">+</span>
            		<span class="s2">&quot;&lt;div class=&#39;boxContent&#39;&gt;&quot;</span><span class="o">+</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="o">+</span>
            		<span class="s2">&quot;&lt;div class=&#39;boxCollapsedContent&#39;&gt;&lt;div class=&#39;verticalContainer boxDragHandle&#39;&gt;&lt;/div&gt;&lt;/div&gt;&quot;</span><span class="o">+</span>
            		<span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">html</span><span class="p">;</span>
        <span class="p">},</span> <span class="c1">// getBoxHtml()</span>

        <span class="nx">replaceBoxFromAjax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">boxId</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Called replaceBoxFromAjax without qstring ... what should i load? :|&#39;</span><span class="p">);</span>
				<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
			<span class="p">}</span>

            <span class="c1">// DEBUG: put this into some fixed variable and not into a string</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">===</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

		    <span class="c1">// DEBUG IE: random string to trick the cache, if there&#39;s no</span>
			<span class="c1">// question mark, add it.. else use &amp;</span>
		    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\?/</span><span class="p">)</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span>
					<span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">+=</span> <span class="s1">&#39;?ie=&#39;</span><span class="o">+</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">+=</span> <span class="s1">&#39;&amp;ie=&#39;</span><span class="o">+</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">);</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">,</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">opts</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
	  				<span class="nx">self</span><span class="p">.</span><span class="nx">replaceBoxContent</span><span class="p">(</span><span class="nx">boxId</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>  
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
			
        <span class="p">},</span> <span class="c1">// replaceBoxFromAjax()</span>

        <span class="c1">// Replaces a box&#39;s content</span>
        <span class="nx">replaceBoxContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">boxId</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">boxId</span><span class="p">)</span> <span class="p">{</span>

				    <span class="nx">b</span><span class="p">.</span><span class="nx">resId</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">newResId</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span><span class="p">;</span>
				    <span class="nx">b</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">newContent</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
				    <span class="nx">b</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">newTitle</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
				    <span class="nx">b</span><span class="p">.</span><span class="nx">verticalTitle</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">newVerticalTitle</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">verticalTitle</span><span class="p">;</span>
				    <span class="nx">b</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">newQstring</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">;</span>
				    
				    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div#&#39;</span><span class="o">+</span><span class="nx">boxId</span><span class="o">+</span><span class="s2">&quot; div.boxContent&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
				    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div#&#39;</span><span class="o">+</span><span class="nx">boxId</span><span class="o">+</span><span class="s2">&quot; h3.boxHeaderTitle&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
				    
        			<span class="c1">// Call the onReplace callback</span>
        			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onReplaceFunctions</span><span class="p">;</span>
        			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
        			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span>
        			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
        			            <span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">resId</span><span class="p">);</span>

                    <span class="c1">// Call resize mainly for the .resizeme images</span>
        			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
        			<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
				<span class="p">}</span> <span class="c1">// if &#39;id&#39; = boxId</span>
			<span class="p">}</span> <span class="c1">// for i</span>
			
			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            
        <span class="p">},</span> <span class="c1">// replaceBoxContent</span>

        <span class="c1">// Updates the internal &#39;content&#39; field to reflect external HTML</span>
        <span class="c1">// injections</span>
        <span class="nx">checkBoxContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">boxId</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">boxId</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">content</span> <span class="o">!=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div#&#39;</span><span class="o">+</span><span class="nx">boxId</span><span class="o">+</span><span class="s2">&quot; div.boxContent&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">())</span>
					    <span class="nx">b</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div#&#39;</span><span class="o">+</span><span class="nx">boxId</span><span class="o">+</span><span class="s2">&quot; div.boxContent&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
					<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span>


		<span class="c1">// Start and stop Drag function just set/unset the isBeingDragged flag</span>
		<span class="c1">// into the boxOptions hash</span>
		<span class="nx">dragStart</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    
            <span class="k">this</span><span class="p">.</span><span class="nx">bvc</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.box&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s2">&quot;z-index&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
			<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s2">&quot;z-index&quot;</span><span class="o">:</span> <span class="mi">10</span><span class="p">});</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;DragStart on id &#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">);</span>
            
			<span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			
				<span class="c1">// Set last order at dragstart, so at drag end we can notice</span>
				<span class="c1">// a change</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isBeingDragged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="c1">// for i</span>

		<span class="p">},</span> <span class="c1">// startDrag</span>


		<span class="nx">dragStop</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

			<span class="kd">var</span> <span class="nx">newOrder</span> <span class="o">=</span> <span class="p">[],</span>
				<span class="nx">isOrderChanged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="c1">// Is the new order different from the last one?</span>
				<span class="nx">newOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">newOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
					<span class="nx">isOrderChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isBeingDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nx">isOrderChanged</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span> <span class="o">=</span> <span class="nx">newOrder</span><span class="p">;</span>

    			<span class="c1">// Call the onSort callback</span>
    			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onSortFunctions</span><span class="p">;</span>
    			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
    			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span>
    			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
    			            <span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
				
			<span class="p">}</span> <span class="c1">// if isOrderChanged</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
		<span class="p">},</span> <span class="c1">// stopDrag</span>

		<span class="c1">// Called at every drag movement of the mouse.. so.. a lot!</span>
		<span class="nx">drag</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

			<span class="c1">// Leftmost and rightmost x coordinate of the dragged box, along</span>
			<span class="c1">// with its central point x coordinate.</span>
			<span class="c1">// drag_box is the index of the dragged box into the boxOptions array,</span>
			<span class="c1">// moving_box is the index of the box that should move to make room to drag_box</span>
			<span class="kd">var</span> <span class="nx">drag_left</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)),</span>
				<span class="nx">drag_right</span> <span class="o">=</span> <span class="nx">drag_left</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)),</span>
				<span class="nx">drag_middle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">drag_left</span><span class="o">+</span><span class="nx">drag_right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
				<span class="nx">drag_box</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				<span class="nx">moving_box</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				<span class="nx">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

			<span class="c1">// Find what&#39;s the box we are dragging</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span>
					<span class="nx">drag_box</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>

			<span class="c1">// Dragged box was on this coordinates before drag happened</span>
			<span class="kd">var</span> <span class="nx">old_drag_left</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">left</span><span class="p">,</span>
				<span class="nx">old_drag_right</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">left</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">width</span><span class="p">;</span>

			<span class="c1">// Just skip all boxes but previous and next to dragged box</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!=</span> <span class="nx">drag_box</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">i</span><span class="o">==</span><span class="nx">drag_box</span><span class="o">+</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">i</span><span class="o">==</span><span class="nx">drag_box</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

					<span class="c1">// Current box left, right and middle coordinates</span>
					<span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">left</span><span class="p">),</span>
						<span class="nx">right</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">width</span><span class="p">)</span> <span class="o">+</span> <span class="nx">left</span><span class="p">,</span>
						<span class="nx">middle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">left</span><span class="o">+</span><span class="nx">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
					
					<span class="c1">// Dragging in right direction</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">old_drag_left</span> <span class="o">&lt;</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">drag_right</span> <span class="o">&gt;</span> <span class="nx">middle</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">changed</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">;</span>
						<span class="nx">moving_box</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>

						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">].</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">old_drag_left</span><span class="p">;</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">left</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">].</span><span class="nx">width</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">boxMargin</span><span class="p">;</span>
					<span class="p">}</span> 

					<span class="c1">// Dragging in left direction</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">old_drag_right</span> <span class="o">&gt;</span> <span class="nx">right</span> <span class="o">&amp;&amp;</span> <span class="nx">drag_left</span> <span class="o">&lt;</span> <span class="nx">middle</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">changed</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>
						<span class="nx">moving_box</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">draggable</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> 
							<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
							
						<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">].</span><span class="nx">left</span><span class="p">;</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">].</span><span class="nx">left</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">width</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">boxMargin</span><span class="p">;</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">].</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
					<span class="p">}</span> 
					
				<span class="p">}</span> <span class="c1">// if boxOptions[i].id != id</span>
			<span class="p">}</span> <span class="c1">// for i</span>

			<span class="c1">// Finally switch boxOptions elements and repaint() !</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">changed</span> <span class="o">!=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">],</span> <span class="p">{});</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">moving_box</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">];</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">drag_box</span><span class="p">]</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">repaint</span><span class="p">();</span>
			<span class="p">}</span> <span class="c1">// if changed != -1</span>
			
		<span class="p">},</span> <span class="c1">// drag</span>

        <span class="nx">setBoxStrapper</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">boxStrapper</span> <span class="o">=</span> <span class="nx">bs</span><span class="p">;</span>
        <span class="p">},</span>

		<span class="c1">// Used to toggle the loading class</span>
		<span class="nx">setLoading</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">b</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> 
						<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">loadingClass</span><span class="p">);</span>
					<span class="k">else</span> 
						<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">loadingClass</span><span class="p">);</span>
					
					<span class="k">this</span><span class="p">.</span><span class="nx">checkBoxContent</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">},</span>

        <span class="nx">isLoading</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> 
				    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;isLoading&#39;</span><span class="p">];</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span>

		<span class="nx">getHistoryBoxItemHTML</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">closed</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">title</span><span class="p">,</span>
                <span class="nx">closed</span> <span class="o">=</span> <span class="nx">closed</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
				<span class="nx">cl</span> <span class="o">=</span> <span class="s1">&#39;history_item &#39;</span><span class="o">+</span><span class="nx">opts</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>

            <span class="c1">// TODO if it is in the history, we can open it back! </span>
    		<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">qstring</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
    			<span class="nx">cl</span> <span class="o">+=</span> <span class="s1">&#39; openable&#39;</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">closed</span><span class="p">)</span> <span class="p">{</span>
    			<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span>   <span class="nx">cl</span> <span class="o">+=</span> <span class="s1">&#39; collapsed&#39;</span><span class="p">;</span>
    			<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">draggable</span><span class="p">)</span>   <span class="nx">cl</span> <span class="o">+=</span> <span class="s1">&#39; draggable&#39;</span><span class="p">;</span>
    			<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">closable</span><span class="p">)</span>    <span class="nx">cl</span> <span class="o">+=</span> <span class="s1">&#39; closable&#39;</span><span class="p">;</span>
    			<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">collapsable</span><span class="p">)</span> <span class="nx">cl</span> <span class="o">+=</span> <span class="s1">&#39; collapsable&#39;</span><span class="p">;</span>
            <span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">verticalTitle</span> <span class="o">!==</span> <span class="nx">$</span><span class="p">.</span><span class="nx">boxView</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">verticalTitle</span><span class="p">)</span>
			 	<span class="nx">title</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">verticalTitle</span><span class="p">;</span>
			<span class="k">else</span> 
				<span class="nx">title</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>

			<span class="k">return</span> <span class="s2">&quot;&lt;div class=&#39;&quot;</span><span class="o">+</span><span class="nx">cl</span><span class="o">+</span><span class="s2">&quot;&#39; about=&#39;&quot;</span><span class="o">+</span><span class="nx">opts</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s2">&quot;&#39;&gt;&quot;</span><span class="o">+</span>
                	<span class="s2">&quot;&lt;span class=&#39;history_status&#39;&gt;&lt;/span&gt;&quot;</span><span class="o">+</span> <span class="nx">title</span> <span class="o">+</span><span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
		<span class="p">},</span>

        <span class="nx">openHistoryBox</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">widget</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nx">opts</span><span class="p">,</span> <span class="nx">openBoxesIds</span> <span class="o">=</span> <span class="p">[];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">useWidgets</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Cant use history box without widgets enabled.&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

            <span class="c1">// TODO: just cycle over .history and see if a box is open checking</span>
            <span class="c1">// if its id is present in the dom .. </span>

            <span class="c1">// Open boxes</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> 
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span> <span class="o">!==</span> <span class="s1">&#39;history&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">widget</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHistoryBoxItemHTML</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                    <span class="nx">openBoxesIds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="nx">content</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">widgetify</span><span class="p">(</span><span class="s2">&quot;Open boxes&quot;</span><span class="p">,</span> <span class="nx">widget</span><span class="p">,</span> 
                        <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;open_boxes&quot;</span><span class="p">,</span> <span class="nx">draggable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">collapsable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">prevnext</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">zoomable</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

            <span class="c1">// Closed boxes</span>
            <span class="nx">widget</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="c1">// if it&#39;s not the history box itself and -1, current resId is not present in openBoxesIds</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> 
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span> <span class="o">!==</span> <span class="s1">&#39;history&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">inArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span><span class="p">,</span> <span class="nx">openBoxesIds</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
					<span class="nx">widget</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHistoryBoxItemHTML</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>

            <span class="nx">content</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">widgetify</span><span class="p">(</span><span class="s2">&quot;Closed boxes&quot;</span><span class="p">,</span> <span class="nx">widget</span><span class="p">,</span> 
                        <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;closed_boxes&quot;</span><span class="p">,</span> <span class="nx">draggable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">collapsable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">prevnext</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">zoomable</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

            <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;History box&quot;</span><span class="p">,</span> 
                <span class="nx">verticalTitle</span><span class="o">:</span> <span class="s2">&quot;Session History&quot;</span><span class="p">,</span> 
                <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> 
                <span class="nx">qstring</span><span class="o">:</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> 
                <span class="nx">resId</span><span class="o">:</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="nx">maxWidth</span><span class="o">:</span> <span class="mi">400</span>
            <span class="p">};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addBox</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

        <span class="p">},</span> <span class="c1">// openHistoryBox()</span>

        <span class="nx">historyToggleCollapsed</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s1">&#39;collapsed&#39;</span><span class="p">);</span>
        <span class="p">},</span> <span class="c1">// updateHistoryBox()</span>

        <span class="nx">historyRemove</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Clone the item in open_boxes to closed_boxes and slide it up</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">clone</span><span class="p">()</span>
                <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;collapsed&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;div.widget.closed_boxes div.widgetContent&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">slideUp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

            <span class="c1">// Now slideToggle both, when done remove the open_boxes item</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">slideToggle</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span> <span class="s1">&#39;easeOutQuint&#39;</span><span class="p">,</span> 
                <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span> <span class="p">});</span>            
        <span class="p">},</span>

        <span class="nx">historyAdd</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
            
			<span class="c1">// History box closed? cool, return.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span> <span class="o">===</span> <span class="s1">&#39;history&#39;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            
            <span class="c1">// Dont push again if we open/close the same box, just move it in</span>
            <span class="c1">// the history box</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> 
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span> <span class="o">===</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">resId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">old_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">,</span>
                        <span class="nx">new_id</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

                    <span class="c1">// Clone the item in closed_boxes into open_boxes and slide it up</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.closed_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">old_id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
                        <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.widgetContent&#39;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">slideUp</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

                    <span class="c1">// Now slideToggle both, when done remove the closes_boxes item</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">old_id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">)</span>
                        <span class="p">.</span><span class="nx">slideToggle</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span> <span class="s1">&#39;easeOutQuint&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.closed_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">old_id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span> <span class="p">})</span>

                    <span class="c1">// Now the box with this same resId has a new id, change </span>
                    <span class="c1">// it in the history box and in the history array</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.history_item[about=&quot;&#39;</span><span class="o">+</span><span class="nx">old_id</span><span class="o">+</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;about&#39;</span><span class="p">,</span> <span class="nx">new_id</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            
            <span class="c1">// Add the item to the history array</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>

			<span class="c1">// And to the open_boxes widget in the history box</span>
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getHistoryBoxItemHTML</span><span class="p">(</span><span class="nx">opts</span><span class="p">))</span>
				<span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;div.widget.open_boxes div.widgetContent&#39;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">slideUp</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>

        <span class="p">},</span> <span class="c1">// historyAdd()</span>

        <span class="c1">// Called when the user clicks on some .history_item .history_action</span>
        <span class="c1">// span item</span>
        <span class="nx">historyHandleClick</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">history_item</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">parent</span><span class="p">(</span><span class="s1">&#39;div.history_item&#39;</span><span class="p">)</span>
                <span class="nx">box</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getOptsFromHistoryId</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">history_item</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;about&#39;</span><span class="p">));</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">historyHandleMouseLeave</span><span class="p">(</span><span class="nx">history_item</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">box</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">addBoxFromAjax</span><span class="p">(</span><span class="nx">box</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">removeBox</span><span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;collapse&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;expand&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">toggleCollapseBox</span><span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;maximize&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">maximizeBox</span><span class="p">(</span><span class="nx">box</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">},</span> <span class="c1">// historyHandleClick()</span>

        <span class="c1">// Called when the mouse enters an .history_item</span>
        <span class="nx">historyHandleMouseEnter</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;openable&#39;</span><span class="p">))</span>
					<span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;history_action open&#39;&gt;Open&lt;/span&gt;&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;closable&#39;</span><span class="p">))</span>
                	<span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;history_action close&#39;&gt;Close&lt;/span&gt;&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;collapsable&#39;</span><span class="p">))</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;collapsed&#39;</span><span class="p">))</span>
						<span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;history_action expand&#39;&gt;Expand&lt;/span&gt;&quot;</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;history_action collapse&#39;&gt;Collapse&lt;/span&gt;&quot;</span><span class="p">);</span>

                <span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;history_action maximize&#39;&gt;Maximize&lt;/span&gt;&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="c1">// historyHandleMouseEnter()</span>

        <span class="c1">// Called when the mouse leaves an .history_item</span>
        <span class="nx">historyHandleMouseLeave</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;span.history_action&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="p">},</span> <span class="c1">// historyHandleMouseLeave()</span>

		<span class="c1">// Removes the box with the given id from the box view container</span>
		<span class="nx">removeBox</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

			<span class="c1">// Will contain the options without the removed box</span>
			<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{},</span> 
			    <span class="nx">removedResid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getResIdFromId</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
			<span class="nx">foo</span><span class="p">[</span><span class="s1">&#39;boxOptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

			<span class="c1">// Cycle over all boxes and just dont copy the selected</span>
			<span class="c1">// id box</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">id</span><span class="p">)</span> 
					<span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="p">{});</span>

			<span class="c1">// Copy back the options in the boxOptions space</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">,</span> <span class="p">{});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="o">--</span><span class="p">;</span>

			<span class="c1">// Remove the element from DOM</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateRemove</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>
			    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="nx">id</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
            <span class="k">else</span>
			    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">historyRemove</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

			<span class="c1">// Call the onRemove callback</span>
			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRemoveFunctions</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span>
			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
			            <span class="nx">f</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">removedResid</span><span class="p">);</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>

		<span class="p">},</span> <span class="c1">// removeBox()</span>
		
		<span class="c1">// Toggle the collapse flag: sets true if it&#39;s false</span>
		<span class="c1">// and vice-versa</span>
		<span class="nx">toggleCollapseBox</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="c1">// Cycling over all boxes options, as soon as we find the given</span>
			<span class="c1">// box we toggle its collapsed flag, add/remove collpsed/expanded</span>
			<span class="c1">// classes and return</span>
			<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

                    <span class="c1">// Update the history box if needed</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">historyToggleCollapsed</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

					<span class="c1">// Expanding the box</span>
					<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>

						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateCollapse</span><span class="p">)</span> <span class="p">{</span>
						    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;collapsed&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;expanded&quot;</span><span class="p">);</span>
                            
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; li&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; .boxContent, #&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; .title&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; li&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">);</span>
                                <span class="p">});</span>
                        <span class="p">}</span> <span class="k">else</span>
						    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;collapsed&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;expanded&quot;</span><span class="p">);</span>

            			<span class="c1">// Call the onExpand callback</span>
            			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onExpandFunctions</span><span class="p">;</span>
            			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
            			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span>
            			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> 
								    <span class="nx">setTimeout</span><span class="p">((</span>
										<span class="kd">function</span><span class="p">(</span><span class="nx">ob</span><span class="p">,</span> <span class="nx">resId</span><span class="p">)</span> <span class="p">{</span>
											<span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
												<span class="nx">ob</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">resId</span><span class="p">)</span> 
											<span class="p">}</span>
										<span class="p">})(</span><span class="nx">f</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span><span class="p">),</span>
										<span class="mi">20</span><span class="p">);</span>

					<span class="c1">// Collapsing the box</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						
						<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animateCollapse</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; li&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;expanded&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;collapsed&quot;</span><span class="p">);</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; .verticalContainer&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; li&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">animationLength</span><span class="p">);</span>
                                <span class="p">});</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; .boxContent&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> 
						    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;expanded&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;collapsed&quot;</span><span class="p">);</span>

            			<span class="c1">// Call the onCollapse callback</span>
            			<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onCollapseFunctions</span><span class="p">;</span>
            			<span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
            			    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span>
            			        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">f</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
								    <span class="nx">setTimeout</span><span class="p">((</span>
										<span class="kd">function</span><span class="p">(</span><span class="nx">ob</span><span class="p">,</span> <span class="nx">resId</span><span class="p">)</span> <span class="p">{</span>
											<span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
												<span class="nx">ob</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">resId</span><span class="p">)</span> 
											<span class="p">}</span>
										<span class="p">})(</span><span class="nx">f</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span><span class="p">),</span>
										<span class="mi">20</span><span class="p">);</span>

					<span class="p">}</span>
        			<span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>

					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span> <span class="c1">// if boxOptions[i][id] == id</span>
		<span class="p">},</span> <span class="c1">// toggleCollapseBox()</span>

        <span class="c1">// Maximize a box expanding it and minimizing all the others</span>
        <span class="nx">maximizeBox</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">toggleCollapseBox</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
			    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapsed</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">toggleCollapseBox</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
			    <span class="p">}</span>
		    <span class="p">}</span>
        <span class="p">},</span> <span class="c1">// maximizeBox()</span>

		<span class="c1">// Returns the box html id from the given Resource ID</span>
		<span class="nx">getIdFromResId</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resId</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span> <span class="o">==</span> <span class="nx">resId</span><span class="p">)</span>
					<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">},</span> <span class="c1">// getIdFromResId()</span>

		<span class="c1">// Returns the box options object from an id, </span>
		<span class="nx">getOptsFromHistoryId</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> 
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> 
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

		<span class="p">},</span> <span class="c1">// getOptsFromHistoryId()</span>

        <span class="nx">getOptsFromId</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resId</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span> <span class="o">==</span> <span class="nx">resId</span><span class="p">)</span>
					<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">},</span> <span class="c1">// getOptsFromId()</span>

		<span class="c1">// Returns the resource id from the given html ID</span>
		<span class="nx">getResIdFromId</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span>
					<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">resId</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">},</span> <span class="c1">// getResIdFromId()</span>

		<span class="c1">// Gets an object in the anchorman format: an array of arrays, </span>
		<span class="c1">// containing info on boxes</span>
		<span class="nx">getAnchorManDesc</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
		        <span class="nx">foo</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">encodeFields</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;getAnchorManDesc: &quot;</span><span class="o">+</span><span class="nx">foo</span><span class="p">);</span>
			<span class="k">return</span> <span class="nx">foo</span><span class="p">;</span>
		<span class="p">},</span> <span class="c1">// getAnchorManDesc()</span>

        <span class="c1">// Takes an object like a boxOptions one (with all of the users fields as well) and</span>
        <span class="c1">// encodes the fields the user decided to encode through the init option object</span>
        <span class="nx">encodeFields</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">anchorManDescription</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">anchorManDescription</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">])</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;encode&#39;</span><span class="o">+</span><span class="nx">field</span><span class="p">])</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;encode&#39;</span><span class="o">+</span><span class="nx">field</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">foo</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">base64Encode</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">]);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">foo</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">];</span>
                    <span class="p">}</span>       
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR: trying to encode unknown field &quot;</span><span class="o">+</span><span class="nx">field</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">};</span> <span class="c1">// for j</span>
            <span class="k">return</span> <span class="nx">foo</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// Same as above, just decoding</span>
        <span class="nx">decodeFields</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">anchorManDescription</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">anchorManDescription</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">])</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;encode&#39;</span><span class="o">+</span><span class="nx">field</span><span class="p">])</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;encode&#39;</span><span class="o">+</span><span class="nx">field</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">foo</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">base64Decode</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">]);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">foo</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">[</span><span class="nx">field</span><span class="p">];</span>
                    <span class="p">}</span>       
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR: trying to decode unknown field &quot;</span><span class="o">+</span><span class="nx">field</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">};</span> <span class="c1">// for j</span>
            <span class="k">return</span> <span class="nx">foo</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">getQStringFromId</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span>
					<span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">encodeResId</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">.</span><span class="nx">base64Encode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qstring</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qstring</span><span class="p">;</span> 
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">},</span>

		<span class="c1">// gets an array of boxes ids and sorts the boxes accordingly</span>
		<span class="nx">sortLike</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newOrder</span><span class="p">)</span> <span class="p">{</span>
			
			<span class="c1">// Giving an order whose size doesnt match current boxes number ..</span>
			<span class="c1">// .. just return.</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">newOrder</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
			    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR SortLike called with a wrong sized array? ..&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            			
			<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="nx">foo</span><span class="p">[</span><span class="s1">&#39;boxOptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

			<span class="c1">// Crappy cycle to set the boxes in the right order</span>
			<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
				<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> 
				 	<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">newOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> 
						<span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="p">{});</span>

			<span class="c1">// Copy back the options in the boxOptions space</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">boxOptions</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">boxOptions</span><span class="p">,</span> <span class="p">{});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">lastOrder</span> <span class="o">=</span> <span class="nx">newOrder</span><span class="p">;</span>
			<span class="c1">// DEBUG: why resize() here?</span>
			<span class="c1">// this.resize();</span>
		<span class="p">},</span> <span class="c1">// sortLike()</span>

		<span class="c1">// Toggles animations on or off</span>
		<span class="nx">toggleAnimations</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animations</span> <span class="o">=</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">animations</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateAdd</span> <span class="o">=</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">animateAdd</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateRemove</span> <span class="o">=</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">animateRemove</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateCollapse</span> <span class="o">=</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">animateCollapse</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateResize</span> <span class="o">=</span> <span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">animateResize</span><span class="p">;</span>
		<span class="p">},</span>
		
		<span class="nx">setAnimations</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
		    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateAdd</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateRemove</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateCollapse</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
			<span class="nx">o</span><span class="p">.</span><span class="nx">animateResize</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
		<span class="p">},</span>

		<span class="nx">setResizemeImagesWidth</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nx">value</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
		    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
		        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesForceMaxWidth</span> <span class="o">=</span> <span class="kc">false</span>
		    <span class="k">else</span> <span class="p">{</span>
		        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesForceMaxWidth</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizemeImagesMaxWidth</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
	        <span class="p">}</span>
	        <span class="k">this</span><span class="p">.</span><span class="nx">repaint</span><span class="p">();</span>
		<span class="p">},</span>

		<span class="c1">// Generates an N items random hash code, to use as box id</span>
		<span class="nx">createHash</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
				<span class="nx">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span>
				
			<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
				<span class="nx">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">rnd</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">36</span><span class="p">);</span>
				<span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvz0123456789&quot;</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">rnd</span><span class="p">,</span> <span class="nx">rnd</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
		<span class="p">},</span> <span class="c1">// createHash()</span>
		
		<span class="nx">log</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">console</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#debug_foo&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> 
                    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div id=&#39;debug_foo&#39; style=&#39;position: absolute; right:2px; bottom: 2px; border: 1px solid red; font-size: 1.1em;&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">);</span>
                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#debug_foo&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="o">+</span><span class="nx">w</span><span class="o">+</span><span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;#BV# &quot;</span><span class="o">+</span><span class="nx">w</span><span class="p">);</span>
            <span class="p">}</span>
        
		<span class="p">}</span> <span class="c1">// log</span>
		
	<span class="p">};</span> <span class="c1">// $.boxView.prototype</span>
	
<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span>
</pre></div>

        </div>

    </div>


    <div class="clear"></div>

    
    <footer>
      <div id="footer" class="grid_16">
        <p>
          Copyright &copy; 2012 Yahoo! Inc.. All rights reserved.
          &middot;
          Docs generated using <a href="http://developer.yahoo.com/yui/yuidoc/">YUIDoc</a> sporting the <a href="http://github.com/carlo/yuidoc-theme-dana">Dana theme</a>.
        </p>
      </div> <!--! end of #footer -->
    </footer>


    <div class="clear"></div>

  </div>

  <!-- Javascript at the bottom for fast page loading -->
  <script src="js/jquery-1.4.2.min.js" type="text/javascript"></script>
  <script src="js/jquery-ui-1.8.4.custom.min.js" type="text/javascript"></script>
  <script src="js/jquery.cookie.min.js" type="text/javascript"></script>
  <script src="js/main.js" type="text/javascript"></script>
  
</body>
</html>
