<% #TODO i18n? %>
<% imt_id = "imt_fi_parade_cart_cards_#{@resource.id}" %>
<%= boxview_widget 'Illustrazione', {:class => 'ImageWidget widget_draggable'} do |w|
  content = imt_viewer(imt_id) do |imt|
    imt.base64 = imt_image_b64 @image, @resource.showable_zones
    imt.init   = "jsapi_initializeIMW(id);"
#    imt.click  = "$('#_zone_'+ki).click();"
#    imt.over   = "$('#ana_zone_'+ki).addClass('zone_highlighted');"
#    imt.out    = "$('#ana_zone_'+ki).removeClass('zone_highlighted');"
  end

  w.content content_tag(:div, content, :class => 'picture')
end
%>
<%= boxview_widget 'Scheda', {:class => 'TextWidget widget_draggable'} do |w|
  w.content boxview_widget_field('Codice', @resource.code)
  w.content boxview_widget_field('Collocazione', @resource.collocation)
  w.content boxview_widget_field('Autore', @resource.author)
  w.content boxview_widget_field('Tecnica e misure', "#{@resource.tecnique} - #{@resource.measure}")
  w.content boxview_widget_field('Note descrittive', @resource.descriptive_notes)
  w.content boxview_widget_field('Ordine di apparizione nella sfilata', @resource.procession_position)
end
%>
<%=
boxview_widget 'Studio', {:class => 'TextWidget widget_draggable'} do |w|
  w.content boxview_widget_field('Descrizione', @resource.description)
  #TODO: add image_zones
  notes = @resource.notes.map {|n| n.name}.join(', ')
  w.content boxview_widget_field('Trascrizioni note manoscritte', notes)

  if @resource.baldini_text or @resource.cini_text
    content =  ""
    if @resource.baldini_text
      link = boxview_link_for_object(@resource.baldini_text)
      content << content_tag(:li, link) 
    end
    if @resource.cini_text
      link = boxview_link_for_object(@resource.cini_text)
      content << content_tag(:li, link) 
    end
    w.content boxview_widget_field('Testi correlati', content_tag(:ul, content))
  end

  # TODO: better sorting, compact
  unless @resource.iconclasses.size.zero?
    iconclasses = @resource.iconclasses.map! do |iconclass|
      %[<a target="_black" href='http://www.iconclass.org/#{iconclass.name}/'>#{iconclass.name}</a>: #{iconclass.pref_label}]
    end
    w.content boxview_widget_field('Codici iconclass', iconclasses.join(', '))
  end

  unless @resource.bibliography_items.size.zero?
    content = @resource.bibliography_items.map do |item|
      content_tag :li, %[#{item.bibliography_item.name} #{item.name}]
    end.join('')
    w.content boxview_widget_field('Fonti', content_tag(:ul, content))
  end

  unless @resource.baldini_text.nil? and @resource.cini_text.nil?
    content = @resource.baldini_text.bibliography_items.map do |item|
      content_tag :li, %[#{item.bibliography_item.name} #{item.name}]
    end.join('') if @resource.baldini_text

    (content ||= "") << @resource.cini_text.bibliography_items.map do |item|
      content_tag :li, %[#{item.bibliography_item.name} #{item.name}]
    end.join('') if @resource.cini_text

    w.content boxview_widget_field('Fonti (indirette o ereditate)', content_tag(:ul, content))
  end

  w.content boxview_widget_field('Note di studio', @resource.study_notes)
end
%>
<%=
boxview_widget 'Elementi collegati', {:class => 'TextWidget widget_draggable'} do |w|
  #TODO: make these links
  content = @resource.procession_characters.map do |el|
              content_tag(:li, el.name)
            end
  w.content boxview_widget_field('Personaggi', content_tag(:ul, content.join(''))) unless content.size.zero?

  #TODO: imt zones, make these links
  content = []
  content << content_tag(:li, "#{t 'DivinitÃ '}: #{@resource.deity.name}")  if @resource.deity
  content << content_tag(:li, "#{t 'Trono'}: #{@resource.throne.name}")    if @resource.throne
  content << content_tag(:li, "#{t 'Veicolo'}: #{@resource.vehicle.name}") if @resource.vehicle
  content << content_tag(:li, "#{t 'Animale'}: #{@resource.animal.name}")  if @resource.animal
  w.content boxview_widget_field('Sezioni carro', content_tag(:ul, content.join(''))) unless content.size.zero?
end
%>
<% unless @resource.bibliography_items.size.zero? %>
<%= 
     boxview_widget 'Bibliografia', :class => "TextWidget widget_draggable" do |w|
       w.content(content_tag :ul, (@resource.bibliography_items.map do |item|
         content_tag :li, %[#{item.bibliography_item.name} #{item.name}]
       end.join('')))
  end
%>
<% end %>
