<!-- Tag definitions for the Admin subsite -->
 
<include src="rapid" plugin="hobo"/>

<include src="taglibs/auto/admin/rapid/cards"/>
<include src="taglibs/auto/admin/rapid/pages"/>
<include src="taglibs/auto/admin/rapid/forms"/>

<set-theme name="clean"/>

<def tag="app-name">Talia Admin Panel</def>

<def tag="card" for="FirbImage">
  <card class="firb-image" param="default" merge>
    <h4 param="heading"><editor:name /> <span><link-del-image /><link-add-to-image /></span></h4> 

    <% @imageid = this.id %>
    <div class="firb-image-picture" id="firb_image_container_#{this.id}">

        <!-- 
        <img class="firb-picture" src="http://auto.blog.nl/files/2008/11/zastava-yugo-45.jpg" />
        -->
        <if test="&this.file_status == 'OK'">
        <imt-viewer id="firb_image_#{@imageid}" b64="PGRjdGxfZXh0X2luaXQ+DQogIDx4bWw+DQogICAgICA8YSByPSJmaXJiX2ltYWdlX3pvbmVfNTIwIiBzPSJ4bWw6Ly9hZmQvbWFybWlfaW1nL3AwMDRraTAwMnAwMDEiIHQ9ImltZzovL2FmZC9tYXJtaV9wMV8wOC5qcGdAMC4zMTczODI4MTI1OjAuMjk2ODc1OjAuMzE1NDI5Njg3NTowLjIzOTU4MzMzMzMzMzMzMzM0OjAuMzQyNzczNDM3NTowLjIxNjE0NTgzMzMzMzMzMzM0OjAuMzgwODU5Mzc1OjAuMjAzMTI1OjAuNDA3MjI2NTYyNTowLjIwNzAzMTI1OjAuNDMyNjE3MTg3NTowLjI1MTMwMjA4MzMzMzMzMzM6MC40NjE5MTQwNjI1OjAuMzA5ODk1ODMzMzMzMzMzMzowLjQ2OTcyNjU2MjU6MC4zOTMyMjkxNjY2NjY2NjY3OjAuNDk0MTQwNjI1OjAuNDQxNDA2MjU6MC41MDQ4ODI4MTI1OjAuNDYzNTQxNjY2NjY2NjY2NzowLjQ5NjA5Mzc1OjAuNDc3ODY0NTgzMzMzMzMzMzowLjQ2NTgyMDMxMjU6MC40ODE3NzA4MzMzMzMzMzMzOjAuNDM5NDUzMTI1OjAuNDcyNjU2MjU6MC40MTUwMzkwNjI1OjAuNDQ3OTE2NjY2NjY2NjY2NzowLjM4Mzc4OTA2MjU6MC40MjMxNzcwODMzMzMzMzMzOjAuMzQ3NjU2MjU6MC4zNzc2MDQxNjY2NjY2NjY3OjAuMzIxMjg5MDYyNTowLjMyNjgyMjkxNjY2NjY2NjciIGw9InBldGFsbyBnaWdhbnRlIDopIiBjPSJhcmVhIDIiLz4NCiAgICAgIDxhIHI9ImZpcmJfaW1hZ2Vfem9uZV81MjEiIHM9InhtbDovL2FmZC9tYXJtaV9pbWcvcDAwNGtpMDAycDAwMSIgdD0iaW1nOi8vYWZkL21hcm1pX3AxXzA4LmpwZ0AwLjM4Mzc4OTA2MjU6MC41NTk4OTU4MzMzMzMzMzM0OjAuNDA5MTc5Njg3NTowLjUzMTI1OjAuNDE0MDYyNTowLjUyMDgzMzMzMzMzMzMzMzQ6MC40MzY1MjM0Mzc1OjAuNTM3NzYwNDE2NjY2NjY2NjowLjQzNzU6MC41NTcyOTE2NjY2NjY2NjY2OjAuNDYzODY3MTg3NTowLjU3MTYxNDU4MzMzMzMzMzQ6MC40NDkyMTg3NTowLjU3ODEyNTowLjQ0MDQyOTY4NzU6MC41NjY0MDYyNTowLjQzMDY2NDA2MjU6MC41NjM4MDIwODMzMzMzMzM0OjAuNDA0Mjk2ODc1OjAuNTcyOTE2NjY2NjY2NjY2NjowLjM5NTUwNzgxMjU6MC41NzI5MTY2NjY2NjY2NjY2OjAuMzgxODM1OTM3NTowLjU2OTAxMDQxNjY2NjY2NjYiIGw9InBpY2NvbGEgc2V6aW9uZSBkaSBjaWVsbyIgYz0iYXJlYSAzIi8+DQogICAgICA8YSByPSJmaXJiX2ltYWdlX3pvbmVfNTE3IiBzPSJ4bWw6Ly9hZmQvbWFybWlfaW1nL3AwMDRraTAwMnAwMDEiIHQ9ImltZzovL2FmZC9tYXJtaV9wMV8wOC5qcGdAMC4yNjg1NTQ2ODc1OjAuNTUzMzg1NDE2NjY2NjY2NjowLjIwMDE5NTMxMjU6MC41MTY5MjcwODMzMzMzMzM0OjAuMTU0Mjk2ODc1OjAuNDQ1MzEyNTowLjE1MDM5MDYyNTowLjM5ODQzNzU6MC4xNzM4MjgxMjU6MC4zNTI4NjQ1ODMzMzMzMzMzOjAuMTkxNDA2MjU6MC4zMzcyMzk1ODMzMzMzMzMzOjAuMjIyNjU2MjU6MC4zMzA3MjkxNjY2NjY2NjY3OjAuMjUzOTA2MjU6MC4zNDUwNTIwODMzMzMzMzMzOjAuMjc2MzY3MTg3NTowLjM3NjMwMjA4MzMzMzMzMzM6MC4yOTAwMzkwNjI1OjAuNDMyMjkxNjY2NjY2NjY2NzowLjI5MTk5MjE4NzU6MC40OTM0ODk1ODMzMzMzMzMzOjAuMjg5MDYyNTowLjUzNTE1NjI1IiBsPSJwZXRhbG8gb21icmVnZ2lhdG8iIGM9ImFyZWEgNCIvPg0KICA8L3htbD4NCiAgPGltZz4NCiAgICA8YSBzPSJpbWc6Ly9hZmQvbWFybWlfcDFfMDguanBnIiB1PSJodHRwOi8vYXV0by5ibG9nLm5sL2ZpbGVzLzIwMDgvMTEvemFzdGF2YS15dWdvLTQ1LmpwZyIgbD0iQW5hc3NpbWFuZHJvIi8+DQogIDwvaW1nPg0KPC9kY3RsX2V4dF9pbml0Pg=="/>
        </if>
        <unless test="&this.file_status == 'OK'">
            <img-not-ready />
        </unless>
        <span><ht key='firb_image.original_name'>Original name</ht>:  something</span>
        <span><link-imt-edit /></span>

    </div>

    <div class="firb-image-zones">
        <h4><%= this.zone_count %> <ht key='firb_image.zones'>zones</ht>:</h4> 
        <ul>
            <li repeat="&this.zones">
                <firbimagezone parentfirbimageid="firb_image_#{@imageid}"/>
            </li>
        </ul>
    </div>

  </card>
</def>

<!-- Shows an image zone, if there's children, shows them as well -->
<def tag="firbimagezone" attrs="parentfirbimageid">
    <span onmouseover="getFlashObject('<%= parentfirbimageid %>').setPolygonHighlighted(true, 'firb_image_zone_<%= this.id.to_s %>');"
        onmouseout="getFlashObject('<%= parentfirbimageid %>').setPolygonHighlighted(false, 'firb_image_zone_<%= this.id.to_s %>');" id="firb_image_zone_#{this.id}" class="single-zone"><editor:name />: <link-add-to-zone /> <link-del-zone /></span>
    <% if this.zone_count > 0 %>
        <ul>
            <li repeat="&this.zones"> <firbimagezone parentfirbimageid="#{parentfirbimageid}"/> </li>
        </ul>
    <% end %>
</def>


<!-- 
    IMT Viewer tag, with parameters:
    - id: used for the id tag and for the embed.name attribute
    - b64: base64 of the xml needed to initialize it
 -->
<def tag="imt-viewer" attrs="id, b64">
    <div class="imt-viewer">
        <object class="IMTViewer" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="#{id}" width="200" height="200" codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab">
            <param name="movie" value="/ImageMapperViewer.swf?js_prefix=jsapi_" />
            <param name="quality" value="high" />
            <param name="bgcolor" value="#ffffff" />
            <param name="allowScriptAccess" value="always" />
            <embed src="/ImageMapperViewer.swf?js_prefix=jsapi_" quality="high" bgcolor="#ffffff" width="100%" height="100%" name="#{id}" align="middle" play="true" loop="false" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.adobe.com/go/getflashplayer" b64="#{b64}"></embed>
        </object>
    </div>
</def>

<def tag="img-not-ready">
    <div class="img-not-ready">
        <img src='/images/icons/hourglass.png' /> <ht key='firb_image.image_not_ready'>Image not ready yet</ht>
        <if test="&this.file_status">
            <br />Status: <%= this.file_status %>
        </if>
    </div>
</def>


<def tag="link-imt-edit">
    <%= link_to "<img src='/images/icons/vector_add.png'> <ht key='firb_image.draw_in_editor'>Draw the zones in the Editor</ht>", {:action => :edit, :controller => :firb_images, :id => this.id}, :title => I18n.t("firb_image.draw_in_editor") %>
</def>

<def tag="link-add-to-image">
    <%= link_to "<img src='/images/icons/layout_add.png'>", {:action => "add_zone", :controller => :firb_images, :id => this.id}, :class => "link-add", :title => I18n.t("firb_image.zone_add") %>
</def>
<def tag="link-add-to-zone">
    <%= link_to "<img src='/images/icons/layout_add.png'>", {:action => "add_zone",  :controller => :firb_image_zones, :id => this.id}, :class => "link-add", :title => I18n.t("firb_image.zone_add") %>
</def>
<def tag="link-del-zone">
    <%= link_to "<img src='/images/icons/cross.png'>", {:action => "remove_zone", :controller => :firb_image_zones, :id => this.id}, :class=> "link-del", :title => I18n.t("firb_image.zone_del") %>
</def>
<def tag="link-del-image">
    <%= link_to "<img src='/images/icons/cross.png'>", {:action => "remove_image", :id => this.id}, :class=> "link-del", :title => I18n.t("firb_image.image_del") %>
</def>


<def tag="card" for="TaliaCollection">
  <card class="talia-collection" param="default" merge>
    <header: param>
      <h4 param="heading"><a><name/></a></h4>
    </header:>
	<body:>
		Contains <%= this.real_collection.elements.size %> Sources
	</body:>
  </card>
</def>

<def tag="card" for="TaliaSource">
  <card class="talia-source" param="default" merge>
    <header: param>
      <h4 param="heading"><a><name/></a></h4>
    </header:>
	<body:>
		<div><%= this.uri %> | <%= this.short_type %></div>
		<div>
			<% source_uri = this.to_uri.safe_encoded %>
			<% can_update = this.with_acting_user(current_user) { this.update_permitted? } %>
			<repeat with="&TaliaCore::Collection.find(:all, :find_through => [N::DCT.hasPart, this.to_uri])" join=", ">
				<%= this.to_uri.local_name %> 
				<if test="&can_update">
				<remote-method-button method="disjoin_collection" label="x" 
					params="&{:collection => this.to_uri.safe_encoded, :source => source_uri }" 
					url="#{url_for(:controller => 'admin/talia_sources', :action => 'remove_collection')}"
					spinner-next-to="#{source_uri}"
					message="Deleting..."
					/>
				</if>
			</repeat>
		</div>
	</body:>
  </card>
</def>

<def tag="prop-language">
	<b>Language:</b> <this.lang if="lang" />
	<else>n/a (default)</else>
</def>

<def tag="semlabel"><this.label if="respond_to?(:label)" /><else><do if="respond_to?(:uri)"><%= this.to_uri.to_name_s %></do><else><%= this.to_s %></else></else></def>

<def tag="prop-type">
	<b>Type:</b> <this.type if="type" />
	<else>n/a (String)</else>
</def>

<def tag="property-string-card">
	<card>
		<header:><h4>"<this/>"</h4></header:>
		<body:>
			<p><prop-type /> <prop-language /></p>
		</body:>
	</card>
</def>

<def tag="property-relation-card">
	<card>
		<header:>
			<h4>
				<wrap tag="a" href="&url_for(:controller => 'admin/talia_sources', :action => this.id)" when="is_a?(TaliaCore::ActiveSource)">
					&lt;<semlabel />&gt;
				</wrap>
			</h4>
		</header:>
		<body:><p><%= this.uri.to_s %></p></body:>
	</card>
	
</def>

<def tag="property-card">
	<property-string-card if="is_a?(TaliaCore::PropertyString)" />
	<else><property-relation-card /></else>
</def>

<def tag="properties">
	<repeat: with="&@properties">
		<h3><%= this_key.to_uri.to_name_s %></h3>
		<property-card repeat param/>
	</repeat:>
</def>

<def tag="sidebared-content">
	<section-group>
		<section param="main-content">
			<header param="content-header">
				<h2 param="heading">
         				<ht key="talia_sources.index.heading">
						<%= model.name.titleize.pluralize %>
         				</ht>
       			</h2>

				<p param="count" if>
					<ht key="talia_sources.collection.count" count="&this.size">
						There <count prefix="are"/>
					</ht>
				</p>
			</header>

			<section param="content-body">
				<a action="new" to="&model" param="new-link">
					<ht key="talia_sources.actions.new">New <%= model.name.titleize %></ht>
				</a>

				<page-nav param="top-page-nav"/>
				
				<section>
					<collection param />
				</section>
			</section>
		</section>
		<aside param />
	</section-group>
</def>

<def tag="main-nav">
  <navigation class="main-nav" merge-attrs param="default">
    <nav-item href="#{base_url}/admin">Home</nav-item>
    <% models = Hobo::Model.all_models.select { |m| linkable?(m, :index) }.sort_by &:name -%>
    <repeat with="&models">
      <nav-item><ht key="#{this.name.tableize}.nav_item"><%= this.view_hints.model_name_plural %></ht></nav-item>
    </repeat>
	<nav-item href="#{url_for(:controller => 'admin/import', :action => 'index')}">Import</nav-item>
  </navigation>
</def>

<extend tag="page">
  <old-page merge without-live-search>
	<app-name: replace><h1><a href="#{base_url}/admin/"><app-name/></a></h1></app-name>
  </old-page>
</extend>
